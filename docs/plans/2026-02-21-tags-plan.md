# Tags & Tag Navigation Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add tags to channel posts and tag-based filtering in the reader sidebar.

**Architecture:** Claude Code generates `tags.json` by analyzing post content. `build_reader.py` loads this file and produces HTML with tag filter UI in the sidebar and tag badges on posts. JS handles single-select tag filtering with localStorage persistence.

**Tech Stack:** Python 3 (stdlib), vanilla JS, CSS

---

## Data Reference

**Current build_reader.py:** `/Users/alexeyprudkin/dev/scrap-tg/scripts/build_reader.py` (682 lines)

Key insertion points:
- **Line 180–347:** CSS constant `CSS`
- **Line 353–515:** JS constant `JS`
- **Line 522–665:** `build_reader()` function
- **Line 551:** threads_dir assignment (after which tags loading should go)
- **Line 553–568:** sidebar HTML building loop
- **Line 572–607:** post HTML building loop
- **Line 631–633:** sidebar HTML insertion in template (where tag filter block should go above sidebar-list)
- **Line 597–606:** post article HTML (where data-tags and tag badges should go)

**tags.json format:**
```json
{
  "9": ["навигация"],
  "154": ["n8n", "claude-code", "автоматизация"]
}
```

---

### Task 1: Generate tags.json

**Files:**
- Create: `downloads/iishenka-pro/tags.json`

**Step 1: Claude Code reads all 139 posts and generates tags**

Read `downloads/iishenka-pro/channel-full/all-messages.json`, analyze each post's text content, and assign 1-4 Russian-language tags per post. Tags should be:
- Lowercase, hyphenated for multi-word (e.g., `claude-code`, `ии-агенты`)
- Reused across posts for consistency
- Reflecting the topic/tool/theme of the post

Common expected tags based on channel content: `n8n`, `claude-code`, `автоматизация`, `видео-урок`, `мастер-класс`, `сообщество`, `обновление`, `деплой`, `ии-агенты`, `вайбкодинг`, `бизнес`, `инструменты`, etc.

**Step 2: Save to `downloads/iishenka-pro/tags.json`**

**Step 3: Commit**

```bash
git add downloads/iishenka-pro/tags.json
git commit -m "feat: add tags.json with auto-generated post tags"
```

---

### Task 2: Load tags in build_reader.py

**Files:**
- Modify: `scripts/build_reader.py:551` (after threads_dir, before sidebar loop)

**Step 1: Add tags loading after line 551**

Insert after `threads_dir = os.path.join(base_dir, "threads")`:

```python
    # Load tags (optional)
    tags_path = os.path.join(base_dir, "tags.json")
    tags = {}
    if os.path.isfile(tags_path):
        with open(tags_path, "r", encoding="utf-8") as f:
            tags = json.load(f)

    # Compute unique tags sorted by frequency (for filter UI)
    tag_counts = {}
    for post_tags in tags.values():
        for t in post_tags:
            tag_counts[t] = tag_counts.get(t, 0) + 1
    sorted_tags = sorted(tag_counts.items(), key=lambda x: -x[1])
```

**Step 2: Add data-tags to sidebar items (modify lines 560-567)**

Change the sidebar item building to include `data-tags`:

```python
        post_tags = tags.get(str(pid), [])
        tags_attr = escape(",".join(post_tags)) if post_tags else ""
        sidebar_html_parts.append(
            f'<div class="sidebar-item" data-post-id="{pid}" data-tags="{tags_attr}">'
            f'<span class="check">&#10003;</span>'
            f'<span class="sid-id">#{pid}</span>'
            f'<span class="sid-date">{escape(short_date(date_ts))}</span>'
            f'{icon}'
            f'<span class="new-badge">NEW</span>'
            f'</div>'
        )
```

**Step 3: Add data-tags and tag badges to posts (modify lines 597-606)**

Change the post article building to include `data-tags` attribute and tag badges:

```python
        post_tags = tags.get(str(pid), [])
        tags_attr = escape(",".join(post_tags)) if post_tags else ""
        tags_badges_html = ""
        if post_tags:
            badges = " ".join(
                f'<span class="tag-badge" data-tag="{escape(t)}">{escape(t)}</span>'
                for t in post_tags
            )
            tags_badges_html = f'<div class="post-tags">{badges}</div>'

        posts_html_parts.append(
            f'<article class="post" id="post-{pid}" data-post-id="{pid}" data-tags="{tags_attr}">'
            f'<div class="post-header">'
            f'<h2>#{pid}</h2>'
            f'{tags_badges_html}'
            f'<div class="post-date">{escape(format_date(date_ts))}</div>'
            f'</div>'
            f'{media_html}'
            f'<div class="post-body">{text_html}</div>'
            f'{thread_html}'
            f'</article>'
        )
```

**Step 4: Add tag filter block to sidebar HTML (modify lines 631-633)**

Insert the tag filter block above the sidebar-list in the template. Change:

```python
<nav id="sidebar" class="sidebar">
  <div class="sidebar-list">
    {sidebar_list_html}
  </div>
```

to:

```python
    # Build tag filter HTML
    tag_filter_html = ""
    if sorted_tags:
        tag_buttons = ['<button class="tag-btn active" data-tag="">все</button>']
        for tag_name, count in sorted_tags:
            tag_buttons.append(
                f'<button class="tag-btn" data-tag="{escape(tag_name)}">'
                f'{escape(tag_name)} <span class="tag-count">&middot;{count}</span></button>'
            )
        tag_filter_html = (
            f'<div class="tag-filter">'
            f'<div class="tag-filter-label">Тэги:</div>'
            f'<div class="tag-filter-list">{"".join(tag_buttons)}</div>'
            f'</div>'
        )
```

Then in the HTML template:

```html
<nav id="sidebar" class="sidebar">
  {tag_filter_html}
  <div class="sidebar-list">
    {sidebar_list_html}
  </div>
```

**Step 5: Add tags count to build output**

Update the print at the end of `build_reader`:

```python
    print(f"  Tags: {len(tag_counts)} unique tags across {sum(1 for v in tags.values() if v)} posts")
```

**Step 6: Run and verify**

Run: `python3 scripts/build_reader.py iishenka-pro`
Expected: Output includes tag count. Open HTML — tags visible but no filtering yet (JS not added).

**Step 7: Commit**

```bash
git add scripts/build_reader.py
git commit -m "feat: load tags.json and render tag filter + badges in reader"
```

---

### Task 3: CSS for tags

**Files:**
- Modify: `scripts/build_reader.py` — CSS constant (lines 180-347)

**Step 1: Add CSS rules before the `/* Mobile */` section (before line 335)**

Insert before `/* Mobile */`:

```css
/* Tag filter */
.tag-filter {
  padding: 10px 12px;
  border-bottom: 1px solid var(--border);
}
.tag-filter-label {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--text-muted);
  margin-bottom: 6px;
}
.tag-filter-list {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
}
.tag-btn {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 2px 10px;
  font-size: 12px;
  cursor: pointer;
  color: var(--text);
  white-space: nowrap;
  transition: all 0.15s;
}
.tag-btn:hover { border-color: var(--accent); }
.tag-btn.active {
  background: var(--accent);
  color: #fff;
  border-color: var(--accent);
}
.tag-count { font-size: 10px; opacity: 0.7; }

/* Tag badges on posts */
.post-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
  margin-bottom: 4px;
}
.tag-badge {
  display: inline-block;
  background: var(--accent-light);
  color: var(--accent);
  font-size: 11px;
  padding: 1px 8px;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.15s;
}
.tag-badge:hover {
  background: var(--accent);
  color: #fff;
}

/* Tag filter visibility */
.hidden-by-tag { display: none !important; }
```

**Step 2: Run and verify styling**

Run: `python3 scripts/build_reader.py iishenka-pro && open downloads/iishenka-pro/reader/index.html`
Expected: Tag filter block visible in sidebar with styled pill buttons. Tag badges visible under post titles.

**Step 3: Commit**

```bash
git add scripts/build_reader.py
git commit -m "feat: add CSS for tag filter and tag badges"
```

---

### Task 4: JavaScript for tag filtering

**Files:**
- Modify: `scripts/build_reader.py` — JS constant (lines 353-515)

**Step 1: Add tag filtering JS**

Insert after the `overlay.addEventListener("click", closeSidebar);` line (after line 402 in the JS string) and before the `// --- New badges ---` comment:

```javascript
  // --- Tag filtering ---
  var activeTag = "";
  var tagButtons = document.querySelectorAll(".tag-btn");
  var tagBadges = document.querySelectorAll(".tag-badge");

  // Restore saved tag filter
  try {
    var savedTag = localStorage.getItem(STORAGE_KEY + "-tag");
    if (savedTag !== null) activeTag = savedTag;
  } catch(e) {}

  function applyTagFilter() {
    posts.forEach(function(p) {
      if (!activeTag) {
        p.classList.remove("hidden-by-tag");
      } else {
        var ptags = (p.dataset.tags || "").split(",");
        p.classList.toggle("hidden-by-tag", ptags.indexOf(activeTag) === -1);
      }
    });
    sidebarItems.forEach(function(item) {
      if (!activeTag) {
        item.classList.remove("hidden-by-tag");
      } else {
        var ptags = (item.dataset.tags || "").split(",");
        item.classList.toggle("hidden-by-tag", ptags.indexOf(activeTag) === -1);
      }
    });
    tagButtons.forEach(function(btn) {
      btn.classList.toggle("active", btn.dataset.tag === activeTag);
    });
    try { localStorage.setItem(STORAGE_KEY + "-tag", activeTag); } catch(e) {}
    updateUI();
  }

  tagButtons.forEach(function(btn) {
    btn.addEventListener("click", function() {
      activeTag = btn.dataset.tag;
      applyTagFilter();
    });
  });

  // Click tag badge on post -> activate filter
  tagBadges.forEach(function(badge) {
    badge.addEventListener("click", function() {
      activeTag = badge.dataset.tag;
      applyTagFilter();
    });
  });
```

**Step 2: Modify updateUI to account for tag filter in counter**

In the existing `updateUI()` function, change the counter logic to count only visible (non-filtered) posts:

Replace:
```javascript
    var counterText = "\\u041F\\u0440\\u043E\\u0447\\u0438\\u0442\\u0430\\u043D\\u043E " + readCount + " \\u0438\\u0437 " + totalPosts;
```

With:
```javascript
    var visibleCount = 0;
    posts.forEach(function(p) { if (!p.classList.contains("hidden-by-tag")) visibleCount++; });
    var shownTotal = activeTag ? visibleCount : totalPosts;
    var counterText = "\\u041F\\u0440\\u043E\\u0447\\u0438\\u0442\\u0430\\u043D\\u043E " + readCount + " \\u0438\\u0437 " + shownTotal;
```

**Step 3: Call applyTagFilter on init**

Change the `// --- Init ---` section at the bottom from:
```javascript
  // --- Init ---
  updateUI();
```

To:
```javascript
  // --- Init ---
  applyTagFilter();
```

(Note: `applyTagFilter()` already calls `updateUI()` at the end.)

**Step 4: Run and verify**

Run: `python3 scripts/build_reader.py iishenka-pro && open downloads/iishenka-pro/reader/index.html`
Expected:
- Click a tag in sidebar filter → only matching posts shown
- Click "все" → all posts shown
- Click tag badge on post → activates that tag filter
- Selected tag persists after page reload
- Counter shows "Прочитано X из Y" where Y = filtered count

**Step 5: Commit**

```bash
git add scripts/build_reader.py
git commit -m "feat: add JS tag filtering with localStorage persistence"
```

---

### Task 5: End-to-end verification

**Step 1: Clean and rebuild**

```bash
rm -rf downloads/iishenka-pro/reader/
python3 scripts/build_reader.py iishenka-pro
```

**Step 2: Verify in browser**

- [ ] Tag filter block shows in sidebar above post list
- [ ] Tags sorted by count, each shows count
- [ ] "все" button is active by default (first visit)
- [ ] Click tag → filters posts in sidebar AND content
- [ ] Click "все" → shows all posts
- [ ] Tag badges visible under post titles
- [ ] Click tag badge on post → activates filter
- [ ] Counter updates with filtered count
- [ ] Selected tag persists on reload (localStorage)
- [ ] Existing read tracking still works
- [ ] NEW badges still work
- [ ] Mobile sidebar still works

**Step 3: Commit**

```bash
git add -A
git commit -m "feat: tags v1 — tag filter and tag badges in channel reader"
```

---

## Summary of Files Changed

| File | Action | Description |
|------|--------|-------------|
| `downloads/iishenka-pro/tags.json` | Create | Tag assignments for all 139 posts |
| `scripts/build_reader.py` | Modify | Load tags, render filter UI + badges, CSS + JS |
